<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Your Cart - DailyDishh</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;700;800;900&display=swap" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    /* Styling wahi purani */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: 'Quicksand', sans-serif; background: #141414; color: #fff; min-height: 100vh; display: flex; flex-direction: column; }
    header { background: rgba(20, 20, 20, 0.95); padding: 15px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
    .back-btn { text-decoration: none; color: #FFC107; font-size: 24px; font-weight: 800; padding: 5px; }
    .page-title { font-family: 'Pacifico', cursive; font-size: 24px; color: #FFC107; margin: 0; }
    .container { max-width: 800px; margin: auto; width: 100%; padding: 20px 15px; flex: 1; }
    .cart-item { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; border-left: 4px solid #FFC107; display: flex; justify-content: space-between; align-items: center; }
    .item-info { flex: 1; padding-right: 10px; }
    .item-name { font-weight: 800; font-size: 14px; margin-bottom: 4px; }
    .item-price { color: #FFC107; font-size: 14px; font-weight: 700; }
    .qty-control { display: flex; align-items: center; gap: 10px; background: #2a2a2a; padding: 6px 10px; border-radius: 8px; border: 1px solid #444; }
    .qty-btn { border: none; background: none; color: #FFC107; font-weight: 900; font-size: 18px; cursor: pointer; }
    .qty-val { font-weight: 800; font-size: 15px; width: 20px; text-align: center; }
    .bill-card { background: #1e1e1e; border-radius: 16px; padding: 20px; margin-top: 25px; border: 1px solid #333; }
    .bill-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #ccc; }
    .total-row { border-top: 1px dashed #444; padding-top: 15px; margin-top: 10px; font-size: 20px; font-weight: 900; color: #FFC107; }
    .user-form { margin-top: 30px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-weight: 800; margin-bottom: 8px; font-size: 13px; color: #FFC107; }
    .form-input { width: 100%; padding: 14px; border: 1px solid #444; border-radius: 10px; background: #2a2a2a; color: #fff; outline: none; }
    
    .pay-btn { display: block; width: 100%; background: #FFC107; color: #000; text-align: center; padding: 18px; font-size: 16px; font-weight: 900; border-radius: 12px; border: none; cursor: pointer; margin-top: 25px; text-transform: uppercase; }
    .empty-state { text-align: center; margin-top: 80px; display: none; }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">←</a>
  <h1 class="page-title">Debug Cart</h1>
</header>

<div class="container">
  <div id="emptyState" class="empty-state">Cart is Empty <br><a href="index.html" style="color:#FFC107">Go back</a></div>

  <div id="cartContent">
    <div id="cartList"></div>

    <div class="bill-card">
      <div class="bill-row"><span>Total</span><span id="billTotal">₹0</span></div>
      <div class="bill-row total-row"><span>Grand Total</span><span id="grandTotal">₹0</span></div>
    </div>

    <div class="user-form">
      <div class="form-group">
        <label class="form-label">NAME</label>
        <input type="text" id="userName" class="form-input" placeholder="Your Name">
      </div>
      <div class="form-group">
        <label class="form-label">ADDRESS</label>
        <textarea id="userAddress" class="form-input" rows="2" placeholder="Address"></textarea>
      </div>
      <button onclick="startPayment()" class="pay-btn">Test Pay Now</button>
    </div>
  </div>
</div>

<script type="module">
  // --- 1. CONFIGURATION ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBAtTlTgmMY3Vc4lh_J1Vsyz3GQCFqVZvo",
    authDomain: "dailydishh-9f8db.firebaseapp.com",
    projectId: "dailydishh-9f8db",
    storageBucket: "dailydishh-9f8db.firebasestorage.app",
    messagingSenderId: "205182364015",
    appId: "1:205182364015:web:d4fda87cb8f7f577ffe09a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let cart = JSON.parse(localStorage.getItem('dailydishh_cart')) || {};
  let finalTotalAmount = 0;

  // Reduced Menu Data for Safety
  const menuPrices = { 
    "Office Lunch Combo": 109, "Power Lunch Combo": 129, "Paneer Lover Combo": 179, "Royal Veg Combo": 279,
    "Special Chole (Half)": 59, "Special Chole (Full)": 89, "Matar Paneer (Half)": 89, "Matar Paneer (Full)": 129,
    "Tawa Roti (Set of 2)": 10, "Tawa Roti (Set of 4)": 28, "Plain Rice (Half)": 49, "Plain Rice (Full)": 79
  };

  function getPrice(name) {
    let cleanName = name.split("(")[0].trim();
    if(menuPrices[cleanName]) return menuPrices[cleanName];
    // Agar exact match na mile
    if(name.includes("Combo") && name.includes("Office")) return 109;
    if(name.includes("Power")) return 129;
    if(name.includes("Royal")) return 279;
    if(name.includes("Paneer Lover")) return 179;
    return 100; // Fallback
  }

  function renderCart() {
    const list = document.getElementById("cartList");
    list.innerHTML = "";
    finalTotalAmount = 0;
    let count = 0;

    for (let name in cart) {
      if (cart[name] > 0) {
        count++;
        let price = getPrice(name);
        let itemTotal = price * cart[name];
        finalTotalAmount += itemTotal;

        list.innerHTML += `
          <div class="cart-item">
            <div class="item-info"><div class="item-name">${name}</div><div class="item-price">₹${price} x ${cart[name]}</div></div>
            <div class="qty-control"><span class="qty-val">${cart[name]}</span></div>
          </div>`;
      }
    }
    
    document.getElementById("billTotal").innerText = "₹" + finalTotalAmount;
    document.getElementById("grandTotal").innerText = "₹" + finalTotalAmount;
    if(count===0) { document.getElementById("emptyState").style.display="block"; document.getElementById("cartContent").style.display="none"; }
  }
  
  renderCart();

  // --- DEBUG PAYMENT LOGIC ---
  window.startPayment = function() {
    const name = document.getElementById("userName").value;
    const address = document.getElementById("userAddress").value;

    if(!name || !address) { alert("Please enter Name & Address!"); return; }

    // DEBUG 1: Check Amount
    alert("Debug Step 1: Checking Amount... \nAmount is: " + finalTotalAmount);

    if(finalTotalAmount <= 0 || isNaN(finalTotalAmount)) {
        alert("ERROR: Amount is 0 or invalid. Please add items again.");
        return;
    }

    // DEBUG 2: Check Key
    const testKey = "Rzp_test_SCSC6eCSj9m804";
    alert("Debug Step 2: Key is " + testKey);

    var options = {
        "key": testKey,
        "amount": finalTotalAmount * 100, 
        "currency": "INR",
        "name": "DailyDishh",
        "description": "Food Order",
        "handler": async function (response) {
            alert("SUCCESS! Payment ID: " + response.razorpay_payment_id);
            // Save to Firebase logic...
            await addDoc(collection(db, "orders"), {
                customer_name: name, address: address, items: cart,
                amount: finalTotalAmount, payment_id: response.razorpay_payment_id,
                status: "New", date: new Date().toLocaleString()
            });
            localStorage.removeItem('dailydishh_cart');
            window.location.href = "index.html";
        },
        "prefill": { "name": name, "contact": "" },
        "theme": { "color": "#FFC107" }
    };
    
    try {
        var rzp1 = new Razorpay(options);
        rzp1.open();
        
        rzp1.on('payment.failed', function (response){
            alert("Razorpay Failed Error: " + response.error.description);
        });
    } catch(err) {
        alert("CRITICAL ERROR: " + err.message);
    }
  }
</script>
</body>
</html>